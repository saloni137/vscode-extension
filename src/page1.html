<html>

<head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>

.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: black;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;
  
  /* Position the tooltip */
  position: absolute;
  z-index: 1;
  bottom: 100%;
  left: 50%;
  margin-left: -60px;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

        button{
            background-color: red;
            color: white;
            padding: 20px;
            display: inline-block;
            font-size: 10px;
            margin: 4px 6px;
            cursor: pointer;
            border-radius: 70%;
            border: none;
        }
           .container video{
         
           padding: 10px;
           height: 600px;
           width: 600px;
           position: absolute;
  
       }
       .container{
           display: inline-flex;
           flex-shrink: 1;
           flex-basis: 50%;
           flex-wrap: wrap;
           position: relative;
     
       }
        video {
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }
    </style>
    <link rel="icon" href="Zujo-Logo-Symbol.ico" type="image/x-icon" />
    <script src="https://sdk.zujonow.com/zujo-sdk-0.0.1.dev.min.js"></script>
    <script>
        ZujoSDK.config("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcGlrZXkiOiIxYTgyNjA2YS02MjcyLTQzZWItODZiYy0xYjE1OWM1ZDE2MWIiLCJpYXQiOjE2MDg2OTczMTQsImV4cCI6MTYwODcxODkxNH0.TS_PVONNnIqOtq4Ls7IBdpc-YT3qk2oKNHJgkjJt-uY");
        async function fetchId() {
            const data = await fetch("http://localhost:9000/setSession");
            const meetingData = await data.json();
            return meetingData;
            return "0000";
        }
        let meeting = "";
        let localParticipant = "";
        fetchId().then(meetingData => {
            const id = meetingData.meetingId;
            meeting = ZujoSDK.initMeeting({
                meetingId: id,
                name: meetingData.meetingName,
                micEnabled: true,
                webcamEnabled: true,
                maxResolution: "hd"
            });

            fetch("http://localhost:9000/sendMeetingId/" + meeting.id).catch(err => {
                console.log(err);
            });

            localParticipant = meeting.localParticipant;

            localParticipant.on("stream-enabled", (stream) => {
                if (stream.kind === "video") {
                    let myVideo = document.createElement('video');
                    myVideo.setAttribute("id", localParticipant.id);
                    myVideo.setAttribute("style", "height:500px;width:500px");
                    const myMediaStream = new MediaStream();
                    myMediaStream.addTrack(stream.track);
                    myVideo.srcObject = myMediaStream;
                    myVideo.autoplay = true;
                 //   document.body.appendChild(myVideo);
                 document.getElementById("div1").appendChild(myVideo);
                    let name = document.createElement('span');
                    name.setAttribute("id", "name" + localParticipant.id);
                    name.setAttribute("style", "color:white");
                    name.innerHTML = localParticipant.displayName;
                    document.body.appendChild(name);
                }
            });

            localParticipant.on("stream-disabled", (stream) => {});

            meeting.on("participant-joined", (participant) => {
                    let text = document.createElement('span');
                text.setAttribute("id", "name" + participant.id);
                text.setAttribute("style", "color:white");
                text.innerHTML = participant.displayName;
                document.body.appendChild(text);
                    
                var apiUrl = 'http://localhost:9000/sendParticipants/' + participant.displayName;
                fetch(apiUrl).then((data) => {

                }).catch(err => {
                    console.log('error');
                    console.log(err.message);
                })
                participant.on("stream-enabled", (stream) => {
                    if (stream.kind === "video") {
                        let video = document.createElement('video');
                        video.setAttribute("id", participant.id);
                        video.setAttribute("style", "height:500px;width:500px");
                        const mediaStream = new MediaStream();
                        mediaStream.addTrack(stream.track);
                        video.srcObject = mediaStream;
                        video.autoplay = true;
                       // document.body.appendChild(video);
                      document.getElementById("div1").appendChild(video);
                    }
                    if (stream.kind === "audio") {
                        var audio = document.createElement('audio');
                        audio.setAttribute("id", participant.id);
                        const mediaStream = new MediaStream();
                        mediaStream.addTrack(stream.track);
                        audio.srcObject = mediaStream;
                        audio.autoplay = true;
                        document.body.appendChild(audio);
                    }
                });
                participant.on("stream-disabled", (stream) => {
                    //disable audio and video
                })
            });

            meeting.on("participant-left", (participant) => {
                console.log("left");
                let api = 'http://localhost:9000/removeParticipants/' + participant.displayName;
                fetch(api).then((data) => {});
            });


            meeting.on("chat-message", (data) => {
                console.log(data);
                const text = data.text;
                const senderId = data.senderId;
                const senderName = data.senderName;
                let span = document.createElement("span");
                span.setAttribute("style", "color:white");
                span.setAttribute("id", senderId);
                span.innerHTML = senderName + " says " + text + "<br>";
                document.getElementById("messages").appendChild(span);
            })

            meeting.join();


        }).catch(err => {
            console.log(err);
            console.log(err.message);
        });

        function leave() {
            meeting.leave();
        }

        function toggleVideo() {
            let streams = localParticipant.streams;
            for (let [key, stream] of streams) {
                if (stream.kind === "video") {
                    let video = document.getElementById(localParticipant.id);
                    video.style.display = "none";
                    meeting.disableWebcam();
                    document.getElementById("vvideo").innerHTML = '<i class="fas fa-video-slash" aria-hidden="true" style="font-size:20px;"></i>';
                    document.getElementById("tooltiptext2").innerHTML="turn on camera";

                } else if (stream.kind !== "video") {
                    meeting.enableWebcam();
                 document.getElementById("vvideo").innerHTML = '<i class="fa fa-video-camera" aria-hidden="true" style="font-size:20px;"></i>';
                 document.getElementById("tooltiptext2").innerHTML="turn off camera";
         
                }
            }
        }

        function toggleAudio() {
            let streams = localParticipant.streams;
            for (let [key, stream] of streams) {
                if (stream.kind === "audio") {
                    meeting.muteMic();
                 document.getElementById("mic").innerHTML = '<i class="fa fa-microphone-slash" aria-hidden="true" style="font-size:20px;"></i>';
                 document.getElementById("tooltiptext1").innerHTML = "unmute";


                } else if (stream.kind !== "audio") {
                    meeting.unmuteMic();
                     document.getElementById("mic").innerHTML ='<i class="fa fa-microphone" aria-hidden="true" style="font-size:20px;"></i>';
                    document.getElementById("tooltiptext1").innerHTML = "mute";

                }
            }
        }

        function sendMessage() {
            let message = document.getElementById("message").value;
            meeting.sendChatMessage(message);
            document.getElementById("message").value = "";
        }
    </script>
</head>

<body>
    <div class="container" id="div1"></div>
  
    <div id="videoDisp" style="  position: absolute;
      bottom: 5px;margin-left: 350px;">
        <div class="tooltip">
       <button id="leave" class="tooleave" onclick="leave()"><i class="fa fa-phone" aria-hidden="true" style="font-size:20px;"></i></button>
       <span class="tooltiptext">leave meeting</span>
        </div>
<div class="tooltip">
    <button id="mic" onclick="toggleAudio()"><i class="fa fa-microphone" aria-hidden="true" style="font-size:20px;"></i></button>
<span class="tooltiptext" id="tooltiptext1">mute</span>
</div>
<div class="tooltip">
<button id="vvideo" onclick="toggleVideo()"><i class="fa fa-video-camera" aria-hidden="true" style="font-size:20px;"></i></button>
<span class="tooltiptext" id="tooltiptext2">turn on camera</span>
</div>
    </div>
   </div>
    
</body>

</html>